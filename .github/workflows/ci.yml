name: Shrinks CI Pipeline

on:
    push:
        branches: [ "main", "dev" ] 
    pull_request:
        branches: [ "main", "dev" ]

jobs:
    test:
        env:
          DATABASE_URL: postgres://user:password@localhost:5432/shrinks?sslmode=disable
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-secret

        runs-on: ubuntu-latest
        services:
          postgres:
            image: postgres:15-alpine
            ports:
              - 5432:5432
            env:
              POSTGRES_USER: user
              POSTGRES_PASSWORD: password
              POSTGRES_DB: shrinks
            options: >-
              --health-cmd "pg_isready -U user -d shrinks"
              --health-interval 5s
              --health-timeout 5s
              --health-retries 5
          redis:
            image: redis:7-alpine
            ports:
              - 6379:6379
            options: >-
              --health-cmd "redis-cli ping"
              --health-interval 5s
              --health-timeout 3s
              --health-retries 5

        steps:
            - uses: actions/checkout@v4 
            - name: Run Linter
              uses: golangci/golangci-lint-action@v6
              with:
                version: latest

            - name: Set up Go 
              uses: actions/setup-go@v5 
              with:
                go-version: '1.24'

            - name: Run Unit Tests
              run: go test -v -tags=unit ./...

            - name: Install & Run Migrations
              run: | 
                go install github.com/pressly/goose/v3/cmd/goose@latest &&
                ~/go/bin/goose -dir db/migrations postgres "$DATABASE_URL" up
            
            - name: Run Integration Tests
              run: go test -v -tags=integration ./...
        
            - name: Build Application
              run: go build -v -o app ./cmd